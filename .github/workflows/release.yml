name: Tatum.CSharp Nuget Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+-rc[0-9]*"

env:
  UPSTREAM_DISPATCH_ADDRESS: https://api.github.com/repos/tatumio/openapi-generator-tatum/actions/workflows/tatumRelease.yml/dispatches

jobs:

  Verify_Origin:
    name: Verify commit exists in master
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Verify commit exists in origin/master
        run: |
          git fetch --no-tags --prune --depth=1 origin +refs/heads/*:refs/remotes/origin/*
          git branch --remote --contains | grep origin/master

  Trim_Version:
    name: Trim version
    runs-on: ubuntu-latest
    steps:
      - name: Trim package version
        run: echo VERSION=${GITHUB_REF_NAME#v} >> $GITHUB_ENV
    needs: Verify_Origin

  Core_Release:
    name: Dispatch Core Release
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Core Release
        run: |
          curl -X POST \
          -H "Authorization: Bearer ${{secrets.DISPATCH_TOKEN}}" \
          -H "Accept: application/vnd.github.v3+json" \
          '${{ env.UPSTREAM_DISPATCH_ADDRESS }}' \
          -d '{"ref": "develop", "inputs": {"source": "New Tatum.CSharp version ${{ github.ref_name }} released", "version": "${VERSION}"}}'
    needs: Trim_Version