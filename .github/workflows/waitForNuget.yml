name: Nuget package listing wait

on:
  workflow_call:
    inputs:
      name:
        required: true
        type: string
      version:
        required: true
        type: string

jobs:
  nuget_wait:
    name: Nuget package wait
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - name: Check if package avaliable
      run: |
          function getListedCount() {
            eval name="$1"
            eval version="$2"
            echo $name
            echo $version
            url="https://azuresearch-usnc.nuget.org/query?q=packageid:Tatum.CSharp.${name}%20version:${version}&prerelease=true"

            echo $url

            curl -o response.json -s -X GET "$url"
            local listedCount="`grep -o '"totalHits":[0-9]*' response.json`"
            local listedCount=${listedCount#*:}
            echo "Total Hits: ${listedCount}"
            return $listedCount
          }

          while true [ $totalHits -gt 0 ]
          do
            getListedCount "${{ inputs.name }}" "${{ inputs.version }}"
            totalHits=$?

            if [ $totalHits -gt 0 ]
            then
              exit 0
            fi

            echo "Sleeping for 30 seconds..."
            sleep 30
          done
          exit 1
