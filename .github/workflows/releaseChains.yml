name: Tatum.CSharp Nuget Release - Chains
run-name: ${{ inputs.version }} - Tatum.CSharp Nuget release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Package Version'
        required: true
        type: string

env:
  DOWNSTREAM_DISPATCH_ADDRESS: https://api.github.com/repos/tatumio/tatum-csharp/actions/workflows/postRelease.yml/dispatches
  DOWNSTREAM_DISPATCH_ADDRESS_UNITY: https://api.github.com/repos/tatumio/tatum-csharp/actions/workflows/prepareUnityPackages.yml/dispatches

jobs:
  Core_Release:
    name: Core - Release
    uses: ./.github/workflows/releaseNugetPackage.yml
    with:
      name: Core
      version: ${{ inputs.version }}
    secrets: inherit

  Nuget_Wait_Core:
    name: Core - Nuget package wait
    uses: ./.github/workflows/waitForNuget.yml
    with:
      name: Core
      version: ${{ inputs.version }}
    secrets: inherit
    needs: Core_Release
    
  Release_Chains:
    strategy:
      matrix:
        arrays: [
          { chain: "Ethereum", dependsOn: "Evm.Local" },
          { chain: "Bitcoin", dependsOn: "Bitcoin.Local" },
          { chain: "Nft", dependsOn: "Evm.Local" },
          { chain: "Polygon", dependsOn: "Evm.Local" }
        ]
    name: ${{ matrix.arrays.chain }} - Release
    uses: ./.github/workflows/releaseSingleChain.yml
    with:
      chain: ${{ matrix.arrays.chain }}
      dependsOn: ${{ matrix.arrays.dependsOn }}
      version: ${{ inputs.version }}
    secrets: inherit
    needs: Nuget_Wait_Core
  
  Post_Release_Tests:
    name: Dispatch Post Release Tests
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Post Release Tests
        run: |
          curl -X POST \
          -H "Authorization: Bearer ${{secrets.DISPATCH_TOKEN}}" \
          -H "Accept: application/vnd.github.v3+json" \
          '${{ env.DOWNSTREAM_DISPATCH_ADDRESS }}' \
          -d '{"ref": "master", "inputs": {"version": "${{ inputs.version }}"}}'
    needs: Release_Chains
    
  Prepare_Unity_Package:
    name: Dispatch Unity Package preparation
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Unity Package preparation
        run: |
          curl -X POST \
          -H "Authorization: Bearer ${{secrets.DISPATCH_TOKEN}}" \
          -H "Accept: application/vnd.github.v3+json" \
          '${{ env.DOWNSTREAM_DISPATCH_ADDRESS_UNITY }}' \
          -d '{"ref": "master", "inputs": {"version": "${{ inputs.version }}"}}'
    needs: Release_Chains