name: SlackNotification
run-name: ${{ inputs.version }} - slack notification

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Package Version'
        required: true
        type: string

jobs:
  Slack_Notification:
    name: Post to a Slack channel
    if: ${{ !contains(inputs.version, 'rc') }}
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3
      - name: Replace 'v$version' in payload-slack-content.json with ${{ inputs.version }}
        run: |
            sed -i "s/v\$version/${{ inputs.version }}/g" payload-slack-content.json
      - name: Replace '$releaseNotes' in payload-slack-content.json with Ethereum.Core package .csproj
        run: |
            sed -i "s/\$releaseNotes/$(grep -oPm1 "(?<=<PackageReleaseNotes>)[^<]+" ./Ethereum/Tatum.CSharp.Ethereum.Core/Tatum.CSharp.Ethereum.Core.csproj)/g" payload-slack-content.json
      - name: From all .csproj files get PackageId and output it as a list (don't include files ending in .Test or .Core)
        run: |
            echo "PackageIdList=$(grep -oPm1 "(?<=<PackageId>)[^<]+" ./*.csproj | grep -v "Test" | grep -v "Core")" >> $GITHUB_ENV
      - name: Get PackageId list from the github gist and output it
        id: getPackageIdList
        uses: actions/github-script@v6
        with:
          script: |
              const gist = await github.rest.gists.get({
                  gist_id: '7c96c30e8017c8dfb57b88e323f8114b'
              })
              console.log(gist.data.files['csharp-sdk-package-list.json'].content)
              const gistContent = JSON.parse(gist.data.files['csharp-sdk-package-list.json'].content)
              const packageIdList = gistContent['packageIdList']
              console.log(packageIdList)
              console.log('::set-output name=packageIdList::' + packageIdList)
          github-token: ${{ secrets.GIST_SECRET }}
      - name: Replace '$packages' in payload-slack-content.json with packageIds, add 'new' tag if there is any new package compared to the list from gist
        run: |
            sed -i "s/\$packages/$(echo ${{ steps.getPackageIdList.outputs.packageIdList }} | sed -e 's/ /, /g')/g" payload-slack-content.json
            if [[ ${{ steps.getPackageIdList.outputs.packageIdList }} != *${{ steps.getPackageId.outputs.packageId }}* ]]; then
                sed -i "s/\$packages/$(echo ${{ steps.getPackageIdList.outputs.packageIdList }} | sed -e 's/ /, /g'), ${{ steps.getPackageId.outputs.packageId }} (new)/g" payload-slack-content.json
            fi
      - name: Update gist with new packageIdList as json array
        uses: actions/github-script@v6
        with:
          script: |
              const packageId = '${{ steps.getPackageId.outputs.packageId }}'
              const gist = await github.rest.gists.update({
                  gist_id: '7c96c30e8017c8dfb57b88e323f8114b',
                  files: {
                      'csharp-sdk-package-list.json': {
                          content: JSON.stringify({ packageIdList: packageId })
                      }
                  }
              })
          github-token: ${{ secrets.GIST_SECRET }}
      - name: Echo content of payload-slack-content.json
        run: |
            cat payload-slack-content.json
#      - name: Post to Slack
#        id: slack
#        uses: slackapi/slack-github-action@v1.23.0
#        with:
#          channel-id: C03VAV2D601
#          payload-file-path: "./payload-slack-content.json"
#        env:
#          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
